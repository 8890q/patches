From a4bcfe640c5aa12a15ae11755e0ea973faac15b2 Mon Sep 17 00:00:00 2001
From: ivanmeler <i_ivan@windowslive.com>
Date: Wed, 9 Mar 2022 18:57:04 +0000
Subject: [PATCH] Revert "Revert "perf: Add hooks used by lineage-sdk""

This reverts commit 60d1e4d09977df14e8b2eda41f191dd2dfc902a7.
---
 core/java/android/os/PowerManagerInternal.java        |  4 ++++
 .../com/android/server/power/PowerManagerService.java | 11 +++++++++++
 services/core/jni/Android.bp                          |  1 +
 .../com_android_server_power_PowerManagerService.cpp  | 11 +++++++++++
 4 files changed, 27 insertions(+)

diff --git a/core/java/android/os/PowerManagerInternal.java b/core/java/android/os/PowerManagerInternal.java
index fca3e76541d0..d8871ad49ef7 100644
--- a/core/java/android/os/PowerManagerInternal.java
+++ b/core/java/android/os/PowerManagerInternal.java
@@ -327,4 +327,8 @@ public abstract class PowerManagerInternal {
 
     /** Allows power button to intercept a power key button press. */
     public abstract boolean interceptPowerKeyDown(KeyEvent event);
+
+    public abstract boolean setPowerSaveMode(boolean mode);
+
+    public abstract int getFeature(int featureId);
 }
diff --git a/services/core/java/com/android/server/power/PowerManagerService.java b/services/core/java/com/android/server/power/PowerManagerService.java
index 53b2b8ba5bda..9108b3623a85 100644
--- a/services/core/java/com/android/server/power/PowerManagerService.java
+++ b/services/core/java/com/android/server/power/PowerManagerService.java
@@ -971,6 +971,7 @@ public final class PowerManagerService extends SystemService
     private static native void nativeSetAutoSuspend(boolean enable);
     private static native void nativeSetPowerBoost(int boost, int durationMs);
     private static native boolean nativeSetPowerMode(int mode, boolean enabled);
+    private static native int nativeGetFeature(int featureId);
     private static native boolean nativeForceSuspend();
 
     private boolean mForceNavbar;
@@ -6472,6 +6473,16 @@ public final class PowerManagerService extends SystemService
         public boolean interceptPowerKeyDown(KeyEvent event) {
             return interceptPowerKeyDownInternal(event);
         }
+
+        @Override
+        public boolean setPowerSaveMode(boolean mode) {
+            return setLowPowerModeInternal(mode);
+        }
+
+        @Override
+        public int getFeature(int featureId) {
+            return nativeGetFeature(featureId);
+        }
     }
 
     private void cleanupProximity() {
diff --git a/services/core/jni/Android.bp b/services/core/jni/Android.bp
index 53401fd47178..81532bcba0ae 100644
--- a/services/core/jni/Android.bp
+++ b/services/core/jni/Android.bp
@@ -183,6 +183,7 @@ cc_defaults {
         "android.system.suspend.control.internal-cpp",
         "android.system.suspend@1.0",
         "service.incremental",
+        "vendor.lineage.power-V1-cpp",
     ],
 
     static_libs: [
diff --git a/services/core/jni/com_android_server_power_PowerManagerService.cpp b/services/core/jni/com_android_server_power_PowerManagerService.cpp
index c3332e5cd3b1..b7180c22195d 100644
--- a/services/core/jni/com_android_server_power_PowerManagerService.cpp
+++ b/services/core/jni/com_android_server_power_PowerManagerService.cpp
@@ -27,6 +27,7 @@
 #include <android/system/suspend/ISuspendControlService.h>
 #include <android/system/suspend/internal/ISuspendControlServiceInternal.h>
 #include <nativehelper/JNIHelp.h>
+#include <vendor/lineage/power/IPower.h>
 #include "jni.h"
 
 #include <nativehelper/ScopedUtfChars.h>
@@ -59,6 +60,7 @@ using android::system::suspend::V1_0::WakeLockType;
 using IPowerV1_1 = android::hardware::power::V1_1::IPower;
 using IPowerV1_0 = android::hardware::power::V1_0::IPower;
 using IPowerAidl = android::hardware::power::IPower;
+using LineageFeatureAidl = vendor::lineage::power::Feature;
 
 namespace android {
 
@@ -204,6 +206,14 @@ void disableAutoSuspend() {
     }
 }
 
+static jint nativeGetFeature(JNIEnv* /* env */, jclass /* clazz */, jint featureId) {
+    auto result = gPowerHalController.getFeature(static_cast<LineageFeatureAidl>(featureId));
+    if (result.isOk()) {
+        return static_cast<jint>(result.value());
+    }
+    return -1;
+}
+
 // ----------------------------------------------------------------------------
 
 static void nativeInit(JNIEnv* env, jobject obj) {
@@ -266,6 +276,7 @@ static const JNINativeMethod gPowerManagerServiceMethods[] = {
         {"nativeSetAutoSuspend", "(Z)V", (void*)nativeSetAutoSuspend},
         {"nativeSetPowerBoost", "(II)V", (void*)nativeSetPowerBoost},
         {"nativeSetPowerMode", "(IZ)Z", (void*)nativeSetPowerMode},
+        {"nativeGetFeature", "(I)I", (void*)nativeGetFeature},
 };
 
 #define FIND_CLASS(var, className) \
-- 
2.25.1

